# chapter07 프로파일링 기법으로 숨겨진 이슈 찾기

프로파일링 조사 기법

- 샘플링을 통해 앱 코드의 어떤 부분이 실행되는지 확인한다.
- 실행을 프로파일링하여 잘못된 부분을 찾아낸다.(인스트루멘테이션)
- 앱을 프로파일링하여 DB와 통신하는 SQL 쿼리를 식별한다.

# 7.1 샘플링으로 실행되는 코드 관찰

앱 프로파일링 첫 번째 단계에 하는 것이 좋고, 이로 충분한 경우가 많다.

1. 샘플링을 통해 어떤 코드가 실행되는지 파악하고, 자세히 들여다 봐야하는지 알아낸다.
2. 프로파일링을 통해 특정 코드의 실행에 관한 상세 정보를 얻는다.

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/78a97c71-706f-4b67-a33c-717a28969280)

앱을 실행한 뒤 VisualVM에 접속하여 샘플링을 시작한다. 목적은 세 가지다.

- 어떤 코드가 실행되는지 알아낸다. : 백그라운드에서 어떤 코드가 실행되는지 알 수 있다.
- CPU 사용량 파악하기 : 레이턴시 문제를 조사하면서 어떤 메서드가 실행 시간을 공유하는지 파악한다.
- 메모리 소비량 파악하기 : 메모리와 관련된 문제를 분석한다.

API를 호출하면, 실행중인 스레드는 리스트에 나열되어, 실행 스택을 펼쳐보면 대략적인 실행 시간을 확인할 수 있다. → 디버깅 포인트를 찾을 수 있다.

프로파일러가 제공하는 정보

- 실행 스택 (스레드 별)
- 레이턴시 시간
- CPU 사용 시간 (높으면 복잡도 조정)

때로는 코드 베이스가 아닌, 디펜던시 메서드가 나타날 때가 있다. 이를 들여다보는 것은 중요하다.

또한, 다이나믹 프록시를 사용해서 실제 코드를 볼 수 없다.

# 7.2 프로파일링으로 메서드의 실행 횟수 파악

로직을 정확히 이해하기 위해 샘플링을 해본 후에 프로파일링 대상을 식별하는 것이 합리적이다.

코드의 전체를 참조하는 것이 아니라, 코드의 범위를 제한하여 보는 것이 좋은데, Profiler 탭의 우측에서 앱의 가로채는 부분을 지정하면 된다.

필터링 규칙

- 각 규칙마다 별도의 라인에 작성한다
- 싱글 애스터리스크(*)는 패키지를 가리킨다.
- 더블 애스터리크스(**)는 패키지와 그 하위 패키지를 모두 가리킨다.
- 클래스 하나만 프로파일링 하려면 클래스 풀 네임을 지정한다.

# 7.3 프로파일러로 앱이 실제로 실행하는 SQL 쿼리 파악

앱이 DB에 전달하는 SQL 쿼리를 가로채서 살펴보고 몇 번 실행되는지 알아볼 수 있다.

## 7.3.1 프로파일러로 프레임워크에서 생성되지 않은 SQL 쿼리 식별

SQL 쿼리를 알아낼 때 SQL 쿼리를 프로파일링을 할 수 있다. (쿼리 실행 횟수도 알 수 있다)

## 7.3.2 프로파일러로 프레임워크에서 생성된 SQL 쿼리 식별

JPQL을 쓰면 백그라운드에서 쿼리가 생성되어 실행된 쿼리를 알기 어렵다.

퍼시스턴스 프레임워크가 일으키는 대부분의 문제는 다음과 같이 정리할 수 있다.

- 레이턴시를 유발하는 느린 쿼리 : 프로파일러로 실행 시간을 조사하면 쉽게 찾아낼 수 있다.
- 프레임워크가 생성한 다수의 불필요한 쿼리 : 개발자 사이에서는 N + 1 쿼리 문제로 더 잘 알려져있다.
- 잘못된앱 설계로 발생한 긴 트랜잭션 커밋 : CPU를 프로파일링 하면 쉽게 발견된다.

## 7.3.3 프로파일러로 프로그램에서 생성된 SQL 쿼리 식별

퍼시스턴스 레이어는 criteria query를 사용하는데, JDBC 드라이버를 프로파일링하여 전송한 쿼리를 가로챈다.

하이버네이트는 앱에서 에러가 발생하기 쉬워서  프로파일링을 습관화 하는게 좋다.

# 요약

- 프로파일러는 앱의 실행을 가로채서 각 스레드의 실행 스택 트레이스, 각 메서드의 실행 시간, 특정 메서드의 호출 횟수 등 실행 중인 코드에 관한 필수 세부 정보를 제공한다.
- 지연 시간 문제를 조사할 때 프로파일러를 사용하는 첫 번째 단계는 샘플링이다. (실행 중인 코드를 가로채는 방법으로, 리소스 소모가 적다)
- 샘플링은 세 가지 필수 세부 정보를 제공한다. (실행 코드, 메서드의 총 실행 시간, CPU 실행)
- 프로파일링은 리소스를 많이 소모하기 때문에, 클래스를 필터링하여 프로파일링 하자.
- 프로파일링으로 얻을 수 있는 필수 세부 정보는 메서드의 호출 횟수다.
- 앱이 DB로 전송한 SQL 쿼리는 프로파일러로 가져올 수 있다.
