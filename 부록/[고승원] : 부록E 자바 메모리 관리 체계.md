# 부록E : 자바 메모리 관리 체계

# E.1 JVM이 앱의 메모리를 구성하는 방법

스택 : 스레드 소유의 독립적인 메모리 공간

힙 : 인스턴스의 데이터가 저장되는 단일 메모리 공간

스레드는 코드 블록에서 로컬로 선언되며, 스레드에서 실행되는 데이터는 모두 스택에 저장된다.

힙은 인스턴스의 데이터와, 클래스에 선언된 애트리뷰트가 저장되는 공간이다.

```java
public static void main(String[] args) {
	int x = 10;
	var c = new Cat();
}
```

여기서 c의 인스턴스는 힙공간에 생성된다. 그리고, x의 값 10과, c의 레퍼런스는 메인 스레드의 스택에 저장된다.

# E.2 스레드가 로컬 데이터를 저장하는 데 사용하는 스택

스택이 어떻게 달라지는지 살펴보자

```java
public static void main(String[] args) {
	int x = 10; --- 1
	a();        --- 2
	b();        --- 3
}

public static void a() {
	int y = 20;
}

public static void a() {
	int y = 30;
}	
```

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/9b805e0f-0f0c-4c54-9e5b-af27df147d33)

다음과 같이 메서드가 종료되면서 y의 값은 사라진다.

스택은 크기가 한정적이어서 가득 차게 되면 StackOverflowError가 발생한다.

스레드마다 스택을 갖고 있기 때문에 다른 스레드에 영향을 끼치진 않는다.

# E.3 앱이 객체 인스턴스를 저장하는 데 사용하는 힙

힙은 모든 스레드가 공유하는 메모리 공간이기 때문에, 경쟁 상태 같은 문제가 발생하기 쉽다. 이를 조사하기 위해 힙 객체의 레퍼런스를 누가 갖고 있는지, 어떻게 저장되는지 알아야 한다.

보통 OOM의 근본 원인은 메모리 누수이고, 이는 원인 스레드가 에러를 발생시키지 않는다.

GC가 힙 공간을 청소해주지만, 객체가 참조중이면 삭제할 수 없다.

# E.4 데이터 유형을 저장하기 위한 메타스페이스 메모리 위치

메타스페이스 : 힙에 저장된 인스턴스를 생성하기 위해 JVM이 데이터 타입을 저장하는 메모리 공간

OOM이 메타스페이스에도 영향을 미치는 경우가 있다.

메타스페이스가 가득 차도 OOM을 던지기도 한다.
