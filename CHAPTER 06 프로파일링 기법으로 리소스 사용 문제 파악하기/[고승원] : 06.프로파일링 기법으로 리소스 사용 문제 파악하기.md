# chapter06 프로파일링 기법으로 리소스 사용 문제 파악하기

프로파일러는 난관에 봉착했을 때 앱의 근본 원인을 밝혀내는 강력한 도구다. 

프로파일러는 JVM 프로세스를 가로채서 유용한 정보를 제공한다.

- CPU와 메모리 같은 리소스가 어떻게 소비되는가?
- 실행중인 스레드와 그 현재 상태는 어떤가?
- 실행중인 코드 및 특정 코드 조각에서 사용하는 리소스는 무엇인가?

# 6.1 프로파일러는 어떤 경우에 유용할까?

- 비정상적인 리소스 사용량 식별
- 코드의 어느 부분이 실행되는지 찾기
- 앱 실행 속도가 저하되는 문제 파악

## 6.1.1 비정상적인 리소스 사용량 식별

프로파일러는 문제 조사의 첫 단추로 사용되며, 보통 두 가지 문제가 있다.

- 스레드 관련 문제 : 동기화 관련 이슈
- 메모리 누수 : 불필요한 메모리를 비우지 못하는 이슈

보통 위 두가지 문제가 대다수이며, 스레드덤프, 메모리 덤프를 통해 근본적인 원인을 조사한다.

## 6.1.2 실행되는 코드 찾기

프로파일러의 코드 샘플링 기능을 사용하면 실행중인 메서드를 시각화 할 수 있다.

샘플링 : 어느 코드가 백그라운드에서 실행 중인지 확인하는 기능

## 6.1.3 앱 실행 속도가 느려지는 원인 파악

보통 I/O를 먼저 의심한다.

프로파일러는 실행 중인 코드를 가로채 리소스를 계산할 수 있다. 7장에서 다룬다

# 6.2 프로파일러 사용 방법

VisualVM을 기준으로 설명한다.

## 6.2.1 실행 및 구성

VisualVM 설치 후 프로세스를 찾아 접속한다.

접속이 안되는 경우

- 프로파일링할 앱을 시작할 때 VM인수로 도메인명을 전달해보자.
    
    ```java
    -Djava.rmi.server.hostname=localhost
    ```
    
- JVM 버전 호환 문제일 수 있다.

## 6.2.2 CPU와 메모리 사용량 관찰

- 좀비 스레드 : 앱 실행이 끝난 뒤에도 계속 실행 상태로 남아 앱의 리소스를 차지하는 경우
- 메모리 누수 : 필요하지 않은 메모리를 계속 점유하고 있는 경우

좀비 스레드를 발견하는 법은 다음과 같다.

- 프로세스의 CPU 사용량 확인
- 프로세스의 메모리 사용량 확인
- 실행 중인 스레드 시각화 및 조사

앱이 종료된 것 처럼 보이지만, CPU 사용량이 줄지 않고, 실행 상태로 남아 있는지 확인해야 한다.

또한 GC가 CPU 리소스를 많이 사용하는 것은 메모리 누수의 징후이며, 많은 처리를 하고 있지만, GC가 CPU 리소스를 거의 사용하지 않는 것은 좀비 스레드를 나타내는 징후이다.

또한, 앱이 생성한 스레드의 실행 여부를 확인하고, 어떤 스레드를 자세히 분석해야 하는지 봐야 한다.

ETC

- 정상적인 앱 동작과, 비정상적인 앱 동작을 자주 보며 감각을 익히는 것이 좋다.
- 스레드 번호로 식별하는건 어려우니, 스레드를 생성할 때 이름을 직접 부여하는 것이 더 좋다.

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/3048f730-d596-4ac5-9dac-86e14a3e82a1)

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/592192c1-855c-4ef6-a33a-d5b195bc3ce8)

## 6.2.3 메모리 누수 현상 식별

메모리 누수는 GC를 사용해도 메모리가 비워지지 않고, 메모리 공간이 동나면서 OOM이 발생하는 경우를 뜻한다.

근원을 밝히는 가장 확실한 방법은 힙 덤프가 좋다.

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/2c5f95d6-b3ba-4ae1-98fe-5ab9a784ccd8)

메모리 누수가 있으면 다음과 같이 피크나 밸리가 없고, 꾸준히 메모리가 증가하는 추세를 보인다. (힙 크기 증가로도 된다)

힙 공간 외에도 메타스페이스 OOM이 발생하기도 한다. 이는 리플렉션과 dynamic proxy 그리고 간접호출을 많이 사용하면 발생하기도 한다.

# 요약

- 프로파일러는 앱 실행을 관찰하여 문제의 원인을 파악하기 유용한 도구다.
    - CPU, Memory 등 리소스 사용량, 사용방법
    - 실행되는 코드와 메서드별 실행 시간
    - 다른 스레드에 있는 메서드 실행 스택
    - 실행 중인 스레드와 그 상태
- 프로파일러는 특정 부분을 더 빠르게 이해하는데 도움 될 만한 위젯을 제공한다.
- 프로파일러로 GC 상태를 관찰해 메모리 누수 식별에 유용하다.
