# chapter11 앱 실행 중 메모리 관련 이슈 찾기

메모리는 한정적이니 할당할때 최적화를 해야한다. 그렇지 않으면 앱이 다운되거나 GC로 인한 CPU 사용량이 증가한다.

메모리 관리 로직 떄문에 앱 크래시가 발생하면 실행 프로파일링이 불가능 하기 때문에 **힙덤프**를 통해서 근본 원인을 파악할 수 있다.

# 11.1 샘플링과 프로파일링으로 메모리 이슈 진단

VisualVM의 Monitor 탭에서 앱의 리소스(CPU, Memory, Classes) 추이를 볼 수 있다. 이 때 메모리 사용량이 급격히 증가한다면, 어떻게 조사해야 할까?

1. 메모리를 샘플링하여 앱이 저장하는 객체 인스턴스에 관한 세부정보를 얻는다. (힙 덤프)
2. 메모리를 프로파일링하여 실행 중인 코드의 특정 부분에 대해 추가적인 세보정보를 얻는다.

보통 인스턴스가 너무 많거나, 인스턴스가 너무 커서 메모리가 가득 차게 되는데, 경우마다 최적화 방법이 다르다.

인스턴스가 너무 크면, 객체를 쪼개어 연산하고, 인스턴스가 너무 많은 경우에는 점유 공간을 확인해야 한다.

Heap histogram을 보면 점유 공간 or 객체 개수 순으로 정렬할 수 있는데, 여기서 primitive 타입은 부산물이니 무시해도 좋다.

공간을 많이 차지하거나 개수가 많은 객체를 알았으니 프로파일링을 해보면 된다. (특정 패키지, 포맷)

스택 트레이스를 따라 근본 원인을 찾으면 된다. 프로파일링을 통해 얻을 수 있는 정보는 다음과 같다.

- live객체
- 앱이 생성한 해당 타입의 총 인스턴스 수
- 인스턴스가 GC에서 생존한 횟수

# 11.2 힙 덤프를 수집하여 메모리 누수가 발생하는 곳 찾기

앱 크래시가 발생하면 프로파일링을 못한다. 그러니 힙 덤프를 통해 알아보자.

## 11.2.1 힙 덤프 수집

힙 덤프를 만드는  세 가지 방법

- OOM으로 앱 크래시가 발생할 때 힙 덤프 자동 생성
    - java -jar로 JVM 옵션을 추가하면 된다. (+HeapDumpOnOutOfMemoryError, HeapDumpPath=
- 프로파일링 도구 사용 (VisualVM)
    - Monito 탭에서 Heap Dump 버튼을 누르면 된다.
- CLI 사용 (jcmd, jmap)
    - PID를 얻어 힙 덤프를 만든다. (jmap -dump:format-b, file=경로 PID)

## 11.2.2 힙 덤프 읽는 방법

힙 덤프 파일을 열먼 요약 정보가 나온다.

- 파일 크기
- 총 클래스 개수
- 총 인스턴스 개수

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/59f81035-0210-47ee-876b-334fb13c21b9)

요약 정보를 통해 힙 덤프에 대한 정보(프로젝트, os, java버전 등)를 볼 수 있고, 객체 인스턴스를 조사할 수 있다.

왜 인스턴스가 많이 생성되는지, 왜 GC의 대상이 되지 않는지 살펴보고(프로파일링) 메모리 누수를 감지하자.

## 11.2.3 OQL 콘솔에서 힙 덤프 쿼리

힙 덤프 고급 조사 기법으로 OQL로 세부 정보를 검색하는 방법이다.

VisualVM의 OQL Console 탭으로 들어가서 사용하면 된다. (http://mng.bz/Pod2)

```java
select * from Product = select p from model.Product p
select name from product = select p.name from model.Product p
select
{
	name: p.name,
	name_length: p.name.value.length
}
from model.Product p
```

쿼리를 통해 누가 해당 인스턴스를 참조하는지, 해당 인스턴스는 어떤 값을 참조하는지 등을 알 수 있다.

그 외에도 OQL의 내장 기본함수도 있다.

- instance refree : 앱이 메모리 누수를 유발하는지
- instance referral : 어떤 인스턴스가 메모리 누수의 원인인지
- 인스턴스 중복 찾기 : 어떤 기능이 메모리를 덜 사용하도록 최적화할 수 있는지
- subclass, superclass 찾기
- long life path 찾기 : 메모리 누수 식별

# 요약

- 메모리에 데이터는 올바르게 할당해야 하며, 최적화는 앱의 성능과 직결된다.
- 프로파일러를 사용하면 앱 실행중 메모리의 샘플링, 프로파일링을 통해 세부내용 열람이 가능하다.
- OOM이 발생하면 프로파일링이 불가하니 힙 덤프를 통해 분석한다. (JVM변수, jmap, 프로파일링도구)
- 프로파일러에서 힙덤프간 관계를 들여다볼 수 있으며, OQL 쿼리를 통해 고급 분석을 할 수 있다.
