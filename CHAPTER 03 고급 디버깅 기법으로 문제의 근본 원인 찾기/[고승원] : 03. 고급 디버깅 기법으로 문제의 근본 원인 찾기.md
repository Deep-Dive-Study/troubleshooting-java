# chapter03 고급 디버깅 기법으로 문제의 근본 원인 찾기

고급 디버깅 기법

- 조건부 브레이크포인트
- 브레이크포인트를 로그 이벤트처럼 활용
- 인메모리 데이터 수정
- 실행 프레임 삭제

# 3.1 조건부 브레이크포인트로 조사 시간 최소화

* 조건부 브레이크포인트 : 디버거가 조건을 만족할 경우에만 실행을 중단하는 브레이크포인트이다.

특정한 케이스에서만 코드가 제대로 실행되지 않을 때 스텝 오버를 계속 할 수 없으니, 조건부 브레이크포인트를 사용해 효율적으로 코드를 탐색하면 된다.

IntelliJ에서 브레이크포인트에서 마우스 우클릭으로 **조건**을 만들 수 있다. 조건은 boolean 조건이어야 한다.

조건부 브레이크포인트에도 단점이 있다. 매번 조건을 체크해야 하므로 성능에 상당히 큰 영향을 미친다.

조건부 브레이크포인트는 여러 표현식 값 또는 특정 조건에 대한 스택 트레이스 등의 **세부 정보**를 기록한다. (모든 IDE가 지원하지는 않는다)

# 3.2 실행을 중단시키지 않고도 브레이크포인트를 사용하는 방법

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/59d7ddcc-5dc1-4be6-9256-f51a4f8a80f7)

다음과 같이 브레이크포인트에서 중단하지 않고, 스택 트레이스를 찍어볼 수 있다.

# 3.3 조사 시나리오를 동적으로 변경하기

다음과 같은 상황은 기존의 디버깅 방식으로 해결이 안된다

- 실행 시간이 긴 프로세스 조사하는 경우
    
    브레이크포인트까지의 시간이 너무 오래 걸린다.
    
- 실행이 매우 빠른 코드이며, 로컬 환경에서 재현할 수 없는 경우(보안)
    
    원격 디버깅이 유용한 조사 기법이지만, 그때마다 변숫값을 바꿔가며 조사하는 방법도 있다.
    

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/1ba4e697-9b66-47dd-b37e-2f9ebcf8bfa9)

변수를 선택 후 우클릭 하여 SetValue를 클릭하여 타입에 맞는 변수를 지정할 수 있다.

이는 실행시 변경된 값을 사용한다.

조건부 브레이크포인트가 더 좋은 경우

- 조사하려는 시나리오를 만들기 위한 데이터가 필요한 경우
- 조사 중인 코드 실행 시간이 짧아 브레이크포인트를 사용해야하는 경우

데이터를 곧바로 변경하는 방식이 더 좋은 경우

- 조사하려는 시나리오를 구동시키는데 필요한 데이터가 없는 경우
- 코드를 실행하는데 너무 오래 걸리는 경우

# 3.4 조사 케이스를 되감기

코드를 디버거로 되돌릴 수 있다. (실행 프레임 드로핑, 실행 프레임 퀴팅)

예를 들어 실행 트레이스에서 프레임을 삭제하면 메서드가 호출된 위치로 돌아간다. (우클릭 후 Drop Frame)

**스텝 아웃과 실행 프레임 드로핑의 차이점** 

스텝 아웃

- 메서드가 리턴되거나, 예외가 발생할 때까지 현재 플랜 내에서 실행이 계속된다.
- 메서드가 종료되면 디버거는 실행을 중단한다.
- 즉 스텝 아웃은 메서드를 완료하고 이전 실행 플랜으로 되돌린다.

실행 프레임 드로핑

- 메서드가 호출되기 전에 이전 플랜으로 돌아간다.
- 즉 되감기와 같다.

프레임 드로핑은 동잉ㄹ한 실행을 여러 번 반복할 때 도움이 된다.

N번 실행하며 스텝을 리뷰하고 어떤 코드가 어떻게 변경하는지 이해할 수 있다.

프레임 드롭으로 되돌릴 수 없는 변경분 (외부 모듈과 통신)

- DB 데이터 수정
- 파일 시스템 변경
- 다른 앱을 호출하여 해당 앱의 데이터 변경
- 다른 앱이 읽는 큐에 메시지를 추가하는 것
- 이메일 메시지 전송

따라서 프레임 드롭을 할 때 다음과 같은 문제 발생 여부를 꼼꼼히 확인하는 것이 좋다.

# 요약

- 조건부 브레이크포인트는 불리언 조건식에 따라 true 일때만 실행을 중단시킨다.
- 브레이크포인트를 사용하면 앱 실행을 중단시키지 않고 변숫값을 콘솔에 찍어볼 수 있다.
- 디버거가 특정 코드 라인의 데이터를 즉석해서 변경할 수 있다.
- 변수값을 변경하는 경우가 적합할 때 (장기간 실행되는 프로세스, 실행되는 환경에 적당한 데이터가 없을 때)
- 조사 플랜에서 스텝 아웃하면 메서드가 호출되기 이전으로 돌아갈 수 있다. 이는 여러 사이드 이펙트가 있으니 문제 발생 여부를 잘 따져보자.
