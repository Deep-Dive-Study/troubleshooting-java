# chapter08 프로파일링한 데이터에 고급 시각화 도구 적용하기

* 플레임 그래프 : 앱의 실행을 시각화 하는 방법으로, 앱 실행을 다른 시각에서 바라보고, 잠재적인 레이턴시 및 성능 문제를 식별하는데 유용하다.

# 8.1 JDBC 접속 문제 감지

JDBC 커넥션 객체를 직접 가져와서 사용할 때 개발자가 직접 닫아야 한다. 이때 제대로 닫지 않으면, 나중엔 커넥션을 가져오지 못해 타임아웃 이휴 오류를 반환한다.

보통 이럴떄 는 둘 중 하나이다.

- 인프라 또는 네트워킹 문제로 DB와 통신 실패
- 인증 실패 또는 DB가 커넥션을 다 썼다.

실행 스택을 보면 앱이 커넥션을 맺기 위해 일정 시간을 대기했지만, CPU 시간이 없음을 알 수 있다.

두 번째 메서드부터 안되는 경우는 네트워크 문제이다. 이런 경우 커넥션이 생성되지 않은건 JProfiler로 어떤 커넥션이 열려있는지 조사해야 한다.

JProfiler로 프로파일링할 프로세스를 선택하고, 인스트루멘테이션과 샘플링중 하나를 고른다.

- 프로파일링을 통해 JDBC에서 DB로 보낸 쿼리를 확인할 수 있다.
- Connections, Connections Leaks를 확인할 수 있다. (커넥션을 잘 닫았는지 확인해야한다)
    - CPU와 스레드명을 통해 Connection Leak 유무를 파악할 수 있다.
- CPU 프로파일링 기능을 크면 커넥션마다 스택 트레이스를 표시할 수 있다. (닫지 않은 코드를 보자)

# 8.2 호출 그래프를 보고 앱의 코드 설계 파악

클래스 설계를 이해할 때, 지저분한 앱을 개발할 때 호출 그래프를 시각화 하면 좋다.

JProfiler의 CPU 프로파일링을 할 때 스택 트레이스를 생성하고, 마우스 우클릭을 통해 Show Call Graph를 하면 볼 수 있다.

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/2323f499-81e4-4ffb-921f-22f7bef32bbd)

# 8.3 플레임 그래프를 그려 성능 문제 밝히기

플레임 그래프는 잠재적인 레이턴시를 발견하는데 유용하다.

JProfiler의 CPU 프로파일링을 할 때 스택 트레이스를 생성하고, 상단 메뉴에서 Analyze를 클릭하여 Show Flame Graph를 선택하면 된다.

플레임 그래프는 그래프 위에 실행된 메서드가 차례대로 보인다.

![image](https://github.com/Deep-Dive-Study/troubleshooting-java/assets/85796588/5413e55f-1816-4324-8141-18772edfe664)

플레임 그래프는 복잡하기 때문에, 패키지별로 레이어에 색상을 넣을 수 있다.

- Colorize 메뉴 선택
- 색상 규칙 추가 및 적용

# 8.4 NoSQL DB에서의 쿼리 분석

NoSQL도 프로파일러로 조사할 수 있다.

JProfiler는 이벤트별로 DB에 어떤 작업을 수행했는지, 그 이름은 무엇인지 알 수 있다.

# 요약

- VisualVM은 어유용한 위젯을 제공한다. 하지만 JProfiler같은 상용 도구는 더욱 다양하게 조사할 수 있다.
- DB 접속 문제는 JProfiler를 사용해 커넥션을 트래킹할 수 있다.
- 정보를 시각화 하면 이해하는데 도움을 줄 수 있다. (호출 그래프, 플레임 그래프)
- NoSQL과의 통신도 조사할 수 있다.
